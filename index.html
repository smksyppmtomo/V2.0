<!doctype html>
<html lang="id" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Absensi SMK YPPM TOMO</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1e293b" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Absensi YPPM" />
    <meta name="description" content="Aplikasi Absensi Guru dan Staff SMK YPPM TOMO" />
    <meta name="mobile-web-app-capable" content="yes" />
    <!-- Favicon & Icons -->
    <link rel="icon" type="image/png" href="https://iili.io/KjIKMJ9.png" />
    <link rel="apple-touch-icon" href="https://iili.io/KjIKMJ9.png" />
    <!-- PWA Manifest -->
    <link
      rel="manifest"
      href="data:application/json;base64,ewogICJuYW1lIjogIkFic2Vuc2kgU01LIFlQUE0gVE9NTyIsCiAgInNob3J0X25hbWUiOiAiQWJzZW5zaSBZUFBNIiwKICAiZGVzY3JpcHRpb24iOiAiQXBsaWthc2kgQWJzZW5zaSBHdXJ1IGRhbiBTdGFmZiBTTUsgWVBQTSBUT01PIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxZTI5M2IiLAogICJ0aGVtZV9jb2xvciI6ICIjMWUyOTNiIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2lpbGkuaW8vS2pJS01KOS5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9paWxpLmlvL0tqSUtNSjkucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/_sdk/element_sdk.js"></script>
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet" />
    <style>
      body {
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      .gradient-bg {
        background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #475569 100%);
      }

      .card-modern {
        background: #ffffff;
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(51, 65, 85, 0.1);
      }

      .btn-gradient {
        background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
      }

      .status-option {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: 3px solid transparent;
        transition: all 0.2s ease;
      }

      .status-option.selected {
        border-color: #1e293b;
        background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
        box-shadow: 0 4px 15px rgba(30, 41, 59, 0.2);
      }

      .status-option.masuk.selected {
        background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      }

      .status-option.pulang.selected {
        background: linear-gradient(135deg, #fcd34d 0%, #fbbf24 100%);
        border-color: #f59e0b;
      }

      .status-option.dinas.selected {
        background: linear-gradient(135deg, #c084fc 0%, #a78bfa 100%);
        border-color: #9333ea;
      }

      .camera-preview {
        transform: scaleX(-1);
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #475569, #334155);
        border-radius: 4px;
      }

      .map-container {
        z-index: 1;
      }

      .toast {
        animation:
          toastIn 0.4s ease-out,
          toastOut 0.4s ease-in 2.6s forwards;
      }

      @keyframes toastIn {
        from {
          transform: translateY(-100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes toastOut {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(-100%);
          opacity: 0;
        }
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-10px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(10px);
        }
      }

      .time-display {
        background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .icon-wrapper {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        position: relative;
      }

      .icon-wrapper::after {
        content: "";
        position: absolute;
        inset: -2px;
        background: linear-gradient(135deg, #f59e0b, #fb923c);
        border-radius: inherit;
        z-index: -1;
        opacity: 0.5;
        filter: blur(8px);
      }

      /* Base mobile-first responsive */
      .app-container {
        width: 100%;
        max-width: 100%;
      }

      /* Extra small devices (phones, 320px and up) */
      @media (min-width: 320px) {
        .card-modern {
          padding: 1rem;
          border-radius: 16px;
        }

        .status-option {
          padding: 0.75rem;
        }

        .status-option .text-center div {
          width: 2.5rem;
          height: 2.5rem;
          margin-bottom: 0.5rem;
        }

        .status-option .text-center svg {
          width: 1.25rem;
          height: 1.25rem;
        }

        .status-option .text-center p {
          font-size: 0.7rem;
        }

        .camera-preview,
        #captured-photo,
        #camera-placeholder {
          height: 200px;
        }

        #map {
          height: 180px;
        }

        .icon-wrapper {
          width: 3.5rem;
          height: 3.5rem;
        }

        .icon-wrapper svg {
          width: 1.75rem;
          height: 1.75rem;
        }

        #current-time {
          font-size: 1.75rem;
        }
      }

      /* Small devices (landscape phones, 480px and up) */
      @media (min-width: 480px) {
        .card-modern {
          padding: 1.25rem;
          border-radius: 20px;
        }

        .status-option {
          padding: 1rem;
        }

        .status-option .text-center div {
          width: 3rem;
          height: 3rem;
          margin-bottom: 0.625rem;
        }

        .status-option .text-center svg {
          width: 1.5rem;
          height: 1.5rem;
        }

        .status-option .text-center p {
          font-size: 0.8rem;
        }

        .camera-preview,
        #captured-photo,
        #camera-placeholder {
          height: 240px;
        }

        #map {
          height: 200px;
        }

        .icon-wrapper {
          width: 4rem;
          height: 4rem;
        }

        .icon-wrapper svg {
          width: 2rem;
          height: 2rem;
        }

        #current-time {
          font-size: 2rem;
        }
      }

      /* Medium devices (tablets, 640px and up) */
      @media (min-width: 640px) {
        .card-modern {
          padding: 1.5rem;
          border-radius: 24px;
        }

        .status-option {
          padding: 1.25rem;
        }

        .status-option .text-center div {
          width: 3.5rem;
          height: 3.5rem;
          margin-bottom: 0.75rem;
        }

        .status-option .text-center svg {
          width: 1.75rem;
          height: 1.75rem;
        }

        .status-option .text-center p {
          font-size: 0.875rem;
        }

        .camera-preview,
        #captured-photo,
        #camera-placeholder {
          height: 280px;
        }

        #map {
          height: 220px;
        }

        .icon-wrapper {
          width: 4.5rem;
          height: 4.5rem;
        }

        .icon-wrapper svg {
          width: 2.25rem;
          height: 2.25rem;
        }

        #current-time {
          font-size: 2.25rem;
        }
      }

      /* Large devices (desktops, 768px and up) */
      @media (min-width: 768px) {
        .card-modern {
          padding: 1.5rem;
        }

        .status-option {
          padding: 1.5rem;
        }

        .status-option .text-center div {
          width: 3.5rem;
          height: 3.5rem;
        }

        .status-option .text-center svg {
          width: 1.75rem;
          height: 1.75rem;
        }

        .status-option .text-center p {
          font-size: 0.875rem;
        }

        .camera-preview,
        #captured-photo,
        #camera-placeholder {
          height: 320px;
        }

        #map {
          height: 240px;
        }

        #current-time {
          font-size: 2.5rem;
        }
      }

      /* Extra large devices (large desktops, 1024px and up) */
      @media (min-width: 1024px) {
        .app-container {
          max-width: 600px;
          margin: 0 auto;
        }

        .card-modern {
          padding: 2rem;
        }

        .status-option {
          padding: 1.75rem;
        }

        .status-option .text-center div {
          width: 4rem;
          height: 4rem;
        }

        .status-option .text-center svg {
          width: 2rem;
          height: 2rem;
        }

        .status-option .text-center p {
          font-size: 1rem;
        }

        .camera-preview,
        #captured-photo,
        #camera-placeholder {
          height: 360px;
        }

        #map {
          height: 280px;
        }

        .icon-wrapper {
          width: 5rem;
          height: 5rem;
        }

        .icon-wrapper svg {
          width: 2.5rem;
          height: 2.5rem;
        }

        #current-time {
          font-size: 2.5rem;
        }
      }

      /* 2XL devices (larger desktops, 1280px and up) */
      @media (min-width: 1280px) {
        .app-container {
          max-width: 640px;
        }

        .card-modern {
          padding: 2.25rem;
        }

        .camera-preview,
        #captured-photo,
        #camera-placeholder {
          height: 400px;
        }

        #map {
          height: 300px;
        }
      }

      /* Ultra wide screens */
      @media (min-width: 1536px) {
        .app-container {
          max-width: 680px;
        }
      }

      /* Landscape orientation adjustments */
      @media (orientation: landscape) and (max-height: 500px) {
        .camera-preview,
        #captured-photo,
        #camera-placeholder {
          height: 220px;
        }

        #map {
          height: 180px;
        }

        .card-modern {
          padding: 1rem;
        }

        .status-option {
          padding: 0.75rem;
        }
      }

      /* Text scaling for smaller devices */
      @media (max-width: 360px) {
        html {
          font-size: 14px;
        }

        .card-modern h2,
        .card-modern h3 {
          font-size: 1.25rem;
        }

        .card-modern .text-lg {
          font-size: 1rem;
        }

        #current-time {
          font-size: 1.5rem;
        }

        .status-option .text-center div {
          width: 2.25rem;
          height: 2.25rem;
        }

        .status-option .text-center svg {
          width: 1.125rem;
          height: 1.125rem;
        }

        .status-option .text-center p {
          font-size: 0.65rem;
        }
      }

      /* Touch target improvements for mobile */
      @media (hover: none) and (pointer: coarse) {
        button,
        select,
        input,
        a {
          min-height: 44px;
          min-width: 44px;
        }

        .status-option {
          min-height: 100px;
        }
      }
    </style>
    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  </head>
  <body class="h-full bg-gradient-to-br from-slate-100 via-slate-50 to-slate-200">
    <div id="app" class="h-full overflow-auto">
      <!-- Toast Container -->
      <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50"></div>
      <!-- Header -->
      <header class="gradient-bg text-white shadow-2xl sticky top-0 z-30">
        <div class="max-w-lg mx-auto px-5 py-5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="relative">
                <img
                  src="https://iili.io/KjIKMJ9.png"
                  alt="Logo SMK YPPM TOMO"
                  class="w-14 h-14 rounded-2xl shadow-2xl bg-white p-1.5"
                  loading="lazy"
                  onerror="
                    this.style.background = '#ffffff';
                    this.alt = 'Logo';
                  "
                />
                <div class="absolute -inset-1 bg-white/30 rounded-2xl blur-md"></div>
              </div>
              <div>
                <h1 id="header-title" class="font-bold text-xl tracking-tight">Absensi</h1>
                <p id="header-school" class="text-sm text-slate-100 font-medium">SMK YPPM TOMO</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="header-install-btn" onclick="installPWA()" class="bg-white/20 hover:bg-white/30 p-2.5 rounded-xl transition backdrop-blur-sm flex items-center justify-center" title="Install Aplikasi">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
              </button>
              <button onclick="promptAdminPassword()" class="bg-white/20 hover:bg-white/30 p-2.5 rounded-xl transition backdrop-blur-sm flex items-center justify-center" title="Admin Panel">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                  />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </header>
      <!-- Main Attendance Page -->
      <div id="page-attendance" class="page active">
        <div class="max-w-lg mx-auto px-5 py-8 space-y-8">
          <!-- Date Time Card -->
          <div class="card-modern p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-slate-300/30 to-slate-200/30 rounded-full blur-3xl"></div>
            <div class="relative flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <div class="w-2 h-2 bg-slate-600 rounded-full"></div>
                  <p class="text-slate-600 text-sm font-medium uppercase tracking-wide">Waktu Saat Ini</p>
                </div>
                <p id="current-date" class="text-slate-700 font-semibold mb-1"></p>
                <p id="current-time" class="text-4xl font-black time-display"></p>
              </div>
              <div class="icon-wrapper w-20 h-20 rounded-2xl flex items-center justify-center shadow-lg">
                <svg class="w-10 h-10 text-orange-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              </div>
            </div>
          </div>
          <!-- Name Selection -->
          <div class="card-modern p-6">
            <label class="block mb-4">
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-700 rounded-xl flex items-center justify-center shadow-lg">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                </div>
                <span class="text-lg font-bold text-slate-800">Pilih Nama Anda</span>
              </div></label
            >
            <select id="staff-select" class="w-full p-4 border-3 border-slate-200 rounded-2xl focus:border-slate-500 focus:ring-4 focus:ring-slate-100 transition text-slate-700 font-semibold bg-white text-base shadow-sm">
              <option value="">-- Pilih Nama Guru/Staff --</option>
            </select>
          </div>
          <!-- Status Selection -->
          <div class="card-modern p-6">
            <div class="flex items-center gap-3 mb-5">
              <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
              </div>
              <span class="text-lg font-bold text-slate-800">Status Kehadiran</span>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <button onclick="selectStatus('masuk')" class="status-option masuk p-5 rounded-2xl hover:shadow-xl" data-status="masuk">
                <div class="text-center">
                  <div class="w-14 h-14 bg-slate-600 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                    </svg>
                  </div>
                  <p class="font-bold text-slate-800 text-sm">Masuk</p>
                </div>
              </button>
              <button onclick="selectStatus('pulang')" class="status-option pulang p-5 rounded-2xl hover:shadow-xl" data-status="pulang">
                <div class="text-center">
                  <div class="w-14 h-14 bg-amber-500 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                  </div>
                  <p class="font-bold text-slate-800 text-sm">Pulang</p>
                </div>
              </button>
              <button onclick="selectStatus('dinas')" class="status-option dinas p-5 rounded-2xl hover:shadow-xl" data-status="dinas">
                <div class="text-center">
                  <div class="w-14 h-14 bg-purple-500 rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-lg">
                    <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                  </div>
                  <p class="font-bold text-slate-800 text-sm">Dinas</p>
                </div>
              </button>
            </div>
          </div>
          <!-- Camera Section -->
          <div class="card-modern p-6">
            <div class="flex items-center gap-3 mb-5">
              <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2.5"
                    d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                  />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <span class="text-lg font-bold text-slate-800">Foto Selfie</span>
            </div>
            <div id="camera-container" class="relative">
              <div id="camera-placeholder" class="w-full h-72 bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl flex flex-col items-center justify-center p-6 border-3 border-dashed border-purple-200">
                <div class="w-16 h-16 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg">
                  <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2.5"
                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                    />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </div>
                <p class="text-slate-700 font-bold mb-4">Klik tombol di bawah untuk membuka kamera</p>
                <button onclick="startCamera()" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-3 rounded-2xl font-bold transition shadow-lg flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                  Buka Kamera
                </button>
              </div>
              <video id="camera-video" class="w-full h-72 object-cover rounded-2xl hidden camera-preview shadow-lg"></video>
              <canvas id="camera-canvas" class="hidden"></canvas><img id="captured-photo" class="w-full h-72 object-cover rounded-2xl hidden shadow-lg" />
              <div id="camera-controls" class="hidden mt-5 flex gap-4">
                <button
                  onclick="capturePhoto()"
                  class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white py-4 rounded-2xl font-bold transition flex items-center justify-center gap-2 shadow-lg"
                >
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2.5"
                      d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"
                    />
                  </svg>
                  Ambil Foto
                </button>
                <button onclick="stopCamera()" class="bg-slate-500 hover:bg-slate-600 text-white px-5 py-4 rounded-2xl font-bold transition shadow-lg">‚úï</button>
              </div>
              <div id="photo-controls" class="hidden mt-5">
                <button onclick="retakePhoto()" class="w-full bg-slate-500 hover:bg-slate-600 text-white py-4 rounded-2xl font-bold transition flex items-center justify-center gap-3 shadow-lg">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                  Ambil Ulang Foto
                </button>
              </div>
            </div>
          </div>
          <!-- Location Section -->
          <div class="card-modern p-6">
            <div class="flex items-center gap-3 mb-5">
              <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl flex items-center justify-center shadow-lg">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <span class="text-lg font-bold text-slate-800">Lokasi Kehadiran</span>
            </div>
            <div id="location-container">
              <div id="location-loading" class="w-full h-56 bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl flex flex-col items-center justify-center border-3 border-dashed border-red-200">
                <div class="w-14 h-14 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-slate-700 font-semibold">Mendapatkan lokasi otomatis...</p>
              </div>
              <div id="location-result" class="hidden">
                <div id="map" class="w-full h-56 rounded-2xl mb-4 map-container shadow-lg"></div>
                <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl p-5 border-2 border-slate-200">
                  <div class="flex items-start gap-3">
                    <div class="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center flex-shrink-0 shadow-md">
                      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      </svg>
                    </div>
                    <div class="flex-1">
                      <p class="text-xs text-slate-500 font-semibold uppercase tracking-wide mb-1">Alamat:</p>
                      <p id="location-address" class="text-slate-700 font-semibold text-sm leading-relaxed"></p>
                      <p class="text-xs text-slate-400 mt-2 font-medium" id="location-coords"></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Submit Button -->
          <button
            id="submit-btn"
            onclick="submitAttendance()"
            disabled
            class="w-full btn-gradient text-white py-5 rounded-2xl font-black text-lg shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
          >
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Kirim Absensi Sekarang
          </button>
        </div>
      </div>
      <!-- Admin Page -->
      <div id="page-admin" class="page">
        <div class="max-w-lg mx-auto px-5 py-8 space-y-8">
          <!-- Back Button -->
          <button onclick="showPage('attendance')" class="flex items-center gap-3 text-slate-600 hover:text-slate-800 transition font-semibold">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg><span>Kembali ke Absensi</span>
          </button>
          <!-- Admin Header -->
          <div class="card-modern p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-slate-300/30 to-slate-200/30 rounded-full blur-3xl"></div>
            <div class="relative flex items-center gap-4">
              <div class="w-16 h-16 bg-gradient-to-br from-slate-600 to-slate-700 rounded-2xl flex items-center justify-center shadow-xl">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2.5"
                    d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                  />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <div>
                <h2 class="text-2xl font-black text-slate-800">Dashboard Admin</h2>
                <p class="text-slate-600 font-medium">Kelola data guru dan staff</p>
              </div>
            </div>
          </div>
          <!-- Add Staff Form -->
          <div class="card-modern p-6">
            <div class="flex items-center gap-3 mb-5">
              <div class="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-700 rounded-xl flex items-center justify-center shadow-lg">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                </svg>
              </div>
              <span class="text-lg font-bold text-slate-800">Tambah Guru/Staff</span>
            </div>
            <form id="add-staff-form" onsubmit="addStaff(event)" class="space-y-4">
              <div>
                <label for="new-staff-name" class="block text-sm font-bold text-slate-700 mb-2">Nama Lengkap</label>
                <input
                  type="text"
                  id="new-staff-name"
                  placeholder="Masukkan nama guru/staff"
                  required
                  class="w-full p-4 border-3 border-slate-200 rounded-2xl focus:border-slate-500 focus:ring-4 focus:ring-slate-100 transition font-semibold shadow-sm"
                />
              </div>
              <button type="submit" id="add-staff-btn" class="w-full btn-gradient text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-3 shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg> Tambah Guru/Staff
              </button>
            </form>
          </div>
          <!-- Staff List -->
          <div class="card-modern p-6">
            <div class="flex items-center justify-between mb-5">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2.5"
                      d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                    />
                  </svg>
                </div>
                <span class="text-lg font-bold text-slate-800">Daftar Guru/Staff</span>
              </div>
              <span id="staff-count" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-4 py-2 rounded-xl text-sm font-black shadow-lg">0</span>
            </div>
            <div id="staff-list" class="space-y-3">
              <p class="text-slate-500 text-center py-6 font-medium">Belum ada data guru/staff</p>
            </div>
          </div>
          <!-- Attendance Records -->
          <div class="card-modern p-6">
            <div class="flex items-center justify-between mb-5">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2.5"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                    />
                  </svg>
                </div>
                <span class="text-lg font-bold text-slate-800">Rekap Absensi</span>
              </div>
              <span id="attendance-count" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-4 py-2 rounded-xl text-sm font-black shadow-lg">0</span>
            </div>
            <!-- Filter -->
            <div class="mb-5 space-y-3">
              <div class="grid grid-cols-1 gap-3">
                <select id="filter-name" onchange="filterAttendance()" class="w-full p-4 border-3 border-slate-200 rounded-2xl focus:border-slate-500 focus:ring-4 focus:ring-slate-100 transition font-semibold shadow-sm bg-white">
                  <option value="">üßë‚Äçüè´ Semua Guru/Staff</option>
                </select>
                <div class="flex gap-3">
                  <input type="date" id="filter-date" onchange="filterAttendance()" class="flex-1 p-4 border-3 border-slate-200 rounded-2xl focus:border-slate-500 focus:ring-4 focus:ring-slate-100 transition font-semibold shadow-sm" />
                  <button onclick="clearFilter()" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-4 rounded-2xl font-bold transition shadow-lg whitespace-nowrap">
                    Reset
                  </button>
                </div>
              </div>
              <p id="filter-info" class="text-sm text-slate-600 font-medium text-center"></p>
            </div>
            <div id="attendance-records" class="space-y-3 max-h-96 overflow-y-auto">
              <p class="text-slate-500 text-center py-6 font-medium">Belum ada data absensi</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Edit Staff Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl card-modern">
        <div>
          <div class="w-20 h-20 bg-gradient-to-br from-slate-600 to-slate-700 rounded-3xl flex items-center justify-center mx-auto mb-5 shadow-xl">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </div>
          <h3 class="text-2xl font-black text-slate-800 mb-5 text-center">Edit Nama Guru/Staff</h3>
          <form onsubmit="saveEditStaff(event)">
            <div class="mb-6">
              <label for="edit-staff-name" class="block text-sm font-bold text-slate-700 mb-2">Nama Lengkap</label>
              <input type="text" id="edit-staff-name" required class="w-full p-4 border-3 border-slate-200 rounded-2xl focus:border-slate-500 focus:ring-4 focus:ring-slate-100 transition font-semibold shadow-sm" />
            </div>
            <div class="flex gap-4">
              <button type="button" onclick="closeEditModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-2xl font-bold transition shadow-md">Batal</button>
              <button type="submit" id="save-edit-btn" class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white py-4 rounded-2xl font-bold transition shadow-lg">Simpan</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl card-modern">
        <div class="text-center">
          <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-rose-600 rounded-3xl flex items-center justify-center mx-auto mb-5 shadow-xl">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </div>
          <h3 class="text-2xl font-black text-slate-800 mb-3">Hapus Data?</h3>
          <p id="delete-modal-text" class="text-slate-600 mb-7 font-medium leading-relaxed">Apakah Anda yakin ingin menghapus data ini?</p>
          <div class="flex gap-4">
            <button onclick="closeDeleteModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-2xl font-bold transition shadow-md">Batal</button>
            <button id="confirm-delete-btn" onclick="confirmDelete()" class="flex-1 bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white py-4 rounded-2xl font-bold transition shadow-lg">Hapus</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Submit Confirmation Modal -->
    <div id="submit-confirmation-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl card-modern">
        <div class="text-center">
          <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-orange-600 rounded-3xl flex items-center justify-center mx-auto mb-5 shadow-xl">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          </div>
          <h3 class="text-2xl font-black text-slate-800 mb-3">Konfirmasi Absensi</h3>
          <div class="bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl p-5 mb-6 border-2 border-slate-200">
            <div class="space-y-3 text-left">
              <div class="flex items-center gap-3">
                <span class="text-2xl">üë§</span>
                <div class="flex-1">
                  <p class="text-xs text-slate-500 font-semibold">Nama:</p>
                  <p id="confirm-name" class="text-slate-800 font-bold"></p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-2xl">üìã</span>
                <div class="flex-1">
                  <p class="text-xs text-slate-500 font-semibold">Status:</p>
                  <p id="confirm-status" class="text-slate-800 font-bold"></p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-2xl">üïê</span>
                <div class="flex-1">
                  <p class="text-xs text-slate-500 font-semibold">Waktu:</p>
                  <p id="confirm-time" class="text-slate-800 font-bold"></p>
                </div>
              </div>
            </div>
          </div>
          <p class="text-slate-600 mb-7 font-medium leading-relaxed">Pastikan data sudah benar sebelum mengirim absensi</p>
          <div class="flex gap-4">
            <button onclick="closeSubmitConfirmation()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-2xl font-bold transition shadow-md">Batal</button>
            <button
              id="confirm-submit-btn"
              onclick="confirmSubmitAttendance()"
              class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white py-4 rounded-2xl font-bold transition shadow-lg"
            >
              Kirim
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl card-modern">
        <div>
          <div class="w-20 h-20 bg-gradient-to-br from-slate-600 to-slate-700 rounded-3xl flex items-center justify-center mx-auto mb-5 shadow-xl">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h3 class="text-2xl font-black text-slate-800 mb-3 text-center">Password Admin</h3>
          <p class="text-slate-600 mb-6 font-medium text-center">Masukkan password untuk akses admin</p>
          <form onsubmit="checkAdminPassword(event)">
            <div class="mb-6">
              <input
                type="password"
                id="admin-password-input"
                placeholder="Masukkan password"
                required
                class="w-full p-4 border-3 border-slate-200 rounded-2xl focus:border-slate-500 focus:ring-4 focus:ring-slate-100 transition font-semibold shadow-sm text-center"
                autofocus
              />
              <p id="password-error" class="text-red-500 text-sm font-semibold mt-2 hidden">Password salah!</p>
            </div>
            <div class="flex gap-4">
              <button type="button" onclick="closePasswordModal()" class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 py-4 rounded-2xl font-bold transition shadow-md">Batal</button>
              <button type="submit" id="check-password-btn" class="flex-1 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white py-4 rounded-2xl font-bold transition shadow-lg">Masuk</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
      // App State
      let staffList = [];
      let attendanceList = [];
      let selectedStatus = null;
      let capturedPhotoData = null;
      let currentLocation = null;
      let map = null;
      let cameraStream = null;
      let deleteTarget = null;
      let deferredPrompt = null;
      let isSubmitting = false;
      let isAddingStaff = false;
      let isLoading = false;

      // Default Config
      const defaultConfig = {
        app_title: "Absensi",
        school_name: "SMK YPPM TOMO",
        apps_script_url: "https://script.google.com/macros/s/AKfycbxCDspWWAsHs1labW5J5yzqVIwftC0DWOT-4q8NXhB028D2GCUO4UKu3Nd_8DWUyWe2KQ/exec",
      };

      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            const title = config.app_title || defaultConfig.app_title;
            const school = config.school_name || defaultConfig.school_name;

            document.getElementById("header-title").textContent = title;
            document.getElementById("header-school").textContent = school;
            document.title = `${title} - ${school}`;
          },
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined,
          }),
          mapToEditPanelValues: (config) =>
            new Map([
              ["app_title", config.app_title || defaultConfig.app_title],
              ["school_name", config.school_name || defaultConfig.school_name],
              ["apps_script_url", config.apps_script_url || defaultConfig.apps_script_url],
            ]),
        });
      }

      // Get Apps Script URL
      function getAppsScriptUrl() {
        if (window.elementSdk && window.elementSdk.config) {
          return window.elementSdk.config.apps_script_url || defaultConfig.apps_script_url;
        }
        return defaultConfig.apps_script_url;
      }

      // Initialize App
      async function initApp() {
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // PWA Install handling
        setupPWA();

        // Get location automatically
        getLocation();

        // Load data from Apps Script
        await loadAllData();
      }

      // Load all data from Google Sheets
      async function loadAllData() {
        const url = getAppsScriptUrl();

        if (!url) {
          console.error("Apps Script URL tidak dikonfigurasi");
          return;
        }

        if (isLoading) return;
        isLoading = true;

        try {
          const response = await fetch(`${url}?action=getAll`);
          const data = await response.json();

          if (data.success) {
            staffList = data.staff || [];
            attendanceList = data.attendance || [];

            updateStaffSelect();
            updateStaffList();
            updateAttendanceRecords();
          }
        } catch (error) {
          console.error("Error loading data:", error);
        } finally {
          isLoading = false;
        }
      }

      // PWA Setup
      function setupPWA() {
        // Check if app is already installed
        if (window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone === true) {
          // App is installed, hide install button
          document.getElementById("header-install-btn").style.display = "none";
        }

        window.addEventListener("beforeinstallprompt", (e) => {
          e.preventDefault();
          deferredPrompt = e;
          // Show install button when prompt is available
          document.getElementById("header-install-btn").style.display = "flex";
        });

        window.addEventListener("appinstalled", () => {
          showToast("Aplikasi berhasil diinstall!", "success");
          // Hide install button after installation
          document.getElementById("header-install-btn").style.display = "none";
          deferredPrompt = null;
        });
      }

      async function installPWA() {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          if (outcome === "accepted") {
            showToast("Terima kasih telah menginstall aplikasi!", "success");
          }
          deferredPrompt = null;
        } else {
          showToast('Untuk menginstall, gunakan menu browser dan pilih "Add to Home Screen" atau "Install App"', "info");
        }
      }

      // Toast Notification
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");

        const colors = {
          success: "bg-gradient-to-r from-slate-600 to-slate-700",
          error: "bg-gradient-to-r from-red-500 to-rose-600",
          info: "bg-gradient-to-r from-slate-500 to-slate-600",
          warning: "bg-gradient-to-r from-amber-500 to-orange-600",
        };

        toast.className = `toast ${colors[type]} text-white px-6 py-4 rounded-2xl shadow-2xl font-bold text-sm max-w-xs text-center`;
        toast.textContent = message;

        container.appendChild(toast);

        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      // Date Time Update
      function updateDateTime() {
        const now = new Date();
        const options = { weekday: "long", year: "numeric", month: "long", day: "numeric" };
        document.getElementById("current-date").textContent = now.toLocaleDateString("id-ID", options);
        document.getElementById("current-time").textContent = now.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
      }

      // Page Navigation
      function showPage(page) {
        document.querySelectorAll(".page").forEach((p) => p.classList.remove("active"));
        document.getElementById(`page-${page}`).classList.add("active");
        window.scrollTo(0, 0);
      }

      // Status Selection
      function selectStatus(status) {
        selectedStatus = status;
        document.querySelectorAll(".status-option").forEach((card) => {
          card.classList.remove("selected");
        });

        const selectedCard = document.querySelector(`[data-status="${status}"]`);
        selectedCard.classList.add("selected");

        checkFormValidity();
      }

      // Camera Functions
      async function startCamera() {
        try {
          cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } },
          });

          const video = document.getElementById("camera-video");
          video.srcObject = cameraStream;
          video.play();

          document.getElementById("camera-placeholder").classList.add("hidden");
          video.classList.remove("hidden");
          document.getElementById("camera-controls").classList.remove("hidden");
        } catch (err) {
          showToast("Tidak dapat mengakses kamera. Pastikan izin kamera diberikan.", "error");
        }
      }

      function capturePhoto() {
        const video = document.getElementById("camera-video");
        const canvas = document.getElementById("camera-canvas");
        const photo = document.getElementById("captured-photo");

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext("2d");
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0);

        capturedPhotoData = canvas.toDataURL("image/jpeg", 0.7);
        photo.src = capturedPhotoData;

        stopCamera();
        video.classList.add("hidden");
        document.getElementById("camera-controls").classList.add("hidden");
        photo.classList.remove("hidden");
        document.getElementById("photo-controls").classList.remove("hidden");

        checkFormValidity();
      }

      function stopCamera() {
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => track.stop());
          cameraStream = null;
        }

        // Hide video and controls, show placeholder
        document.getElementById("camera-video").classList.add("hidden");
        document.getElementById("camera-controls").classList.add("hidden");
        document.getElementById("camera-placeholder").classList.remove("hidden");
      }

      function retakePhoto() {
        capturedPhotoData = null;
        document.getElementById("captured-photo").classList.add("hidden");
        document.getElementById("photo-controls").classList.add("hidden");
        document.getElementById("camera-placeholder").classList.remove("hidden");
        checkFormValidity();
      }

      // Location Functions
      async function getLocation() {
        if (!navigator.geolocation) {
          showToast("Geolokasi tidak didukung di browser ini", "error");
          document.getElementById("location-loading").innerHTML = `
          <svg class="w-16 h-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <p class="text-slate-700 font-semibold">Geolokasi tidak didukung</p>
        `;
          return;
        }

        navigator.geolocation.getCurrentPosition(
          async (position) => {
            currentLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            // Get address using reverse geocoding
            try {
              const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocation.lat}&lon=${currentLocation.lng}`);
              const data = await response.json();
              currentLocation.address = data.display_name || "Alamat tidak ditemukan";
            } catch (err) {
              currentLocation.address = "Alamat tidak dapat diambil";
            }

            document.getElementById("location-loading").classList.add("hidden");
            document.getElementById("location-result").classList.remove("hidden");
            document.getElementById("location-address").textContent = currentLocation.address;
            document.getElementById("location-coords").textContent = `Koordinat: ${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;

            // Initialize map
            if (map) {
              map.remove();
            }

            map = L.map("map").setView([currentLocation.lat, currentLocation.lng], 17);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: "¬© OpenStreetMap",
            }).addTo(map);

            L.marker([currentLocation.lat, currentLocation.lng]).addTo(map).bindPopup("Lokasi Anda").openPopup();

            checkFormValidity();
          },
          (error) => {
            let message = "Gagal mendapatkan lokasi";
            let icon = "M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z";

            if (error.code === 1) {
              message = "Izin lokasi ditolak. Aktifkan izin lokasi untuk melanjutkan.";
            }
            if (error.code === 2) {
              message = "Lokasi tidak tersedia";
            }
            if (error.code === 3) {
              message = "Waktu habis mendapatkan lokasi";
            }

            document.getElementById("location-loading").innerHTML = `
            <svg class="w-16 h-16 text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="${icon}"/>
            </svg>
            <p class="text-slate-700 font-semibold text-center px-4">${message}</p>
          `;

            showToast(message, "error");
          },
          { enableHighAccuracy: true, timeout: 15000 },
        );
      }

      // Form Validation
      function checkFormValidity() {
        const staffSelect = document.getElementById("staff-select");
        const isValid = staffSelect.value && selectedStatus && capturedPhotoData && currentLocation;
        document.getElementById("submit-btn").disabled = !isValid;
      }

      // Show Submit Confirmation
      function submitAttendance() {
        const staffSelect = document.getElementById("staff-select");
        const selectedName = staffSelect.value;

        if (!selectedName || !selectedStatus || !capturedPhotoData || !currentLocation) {
          showToast("Lengkapi semua data terlebih dahulu", "error");
          return;
        }

        const url = getAppsScriptUrl();
        if (!url) {
          showToast("URL Apps Script belum dikonfigurasi. Klik tombol pengaturan untuk menambahkan URL.", "error");
          return;
        }

        // Show confirmation modal
        const statusLabels = {
          masuk: "Masuk",
          pulang: "Pulang",
          dinas: "Dinas Luar",
        };

        const now = new Date();
        document.getElementById("confirm-name").textContent = selectedName;
        document.getElementById("confirm-status").textContent = statusLabels[selectedStatus];
        document.getElementById("confirm-time").textContent =
          now.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          }) +
          " - " +
          now.toLocaleDateString("id-ID", {
            day: "numeric",
            month: "short",
            year: "numeric",
          });

        document.getElementById("submit-confirmation-modal").classList.remove("hidden");
      }

      function closeSubmitConfirmation() {
        document.getElementById("submit-confirmation-modal").classList.add("hidden");
      }

      // Confirm Submit Attendance
      async function confirmSubmitAttendance() {
        if (isSubmitting) return;

        const staffSelect = document.getElementById("staff-select");
        const selectedName = staffSelect.value;

        if (!selectedName || !selectedStatus || !capturedPhotoData || !currentLocation) {
          showToast("Lengkapi semua data terlebih dahulu", "error");
          closeSubmitConfirmation();
          return;
        }

        const url = getAppsScriptUrl();
        if (!url) {
          showToast("URL Apps Script belum dikonfigurasi. Klik tombol pengaturan untuk menambahkan URL.", "error");
          closeSubmitConfirmation();
          return;
        }

        isSubmitting = true;
        const confirmBtn = document.getElementById("confirm-submit-btn");
        confirmBtn.innerHTML = '<div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin"></div>';
        confirmBtn.disabled = true;

        const now = new Date();
        const attendanceData = {
          action: "addAttendance",
          name: selectedName,
          date: now.toISOString().split("T")[0],
          time: now.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit", second: "2-digit" }),
          status: selectedStatus,
          photo: capturedPhotoData,
          latitude: currentLocation.lat,
          longitude: currentLocation.lng,
          address: currentLocation.address,
          timestamp: now.toISOString(),
        };

        try {
          const response = await fetch(url, {
            method: "POST",
            body: JSON.stringify(attendanceData),
          });

          const result = await response.json();

          if (result.success) {
            showToast("Absensi berhasil disimpan!", "success");
            closeSubmitConfirmation();
            resetForm();
            await loadAllData();
          } else {
            showToast(result.message || "Gagal menyimpan absensi", "error");
            confirmBtn.innerHTML = "Kirim";
            confirmBtn.disabled = false;
          }
        } catch (error) {
          showToast("Error mengirim data: " + error.message, "error");
          confirmBtn.innerHTML = "Kirim";
          confirmBtn.disabled = false;
        } finally {
          isSubmitting = false;
        }
      }

      // Reset Form
      function resetForm() {
        document.getElementById("staff-select").value = "";
        selectedStatus = null;
        capturedPhotoData = null;
        currentLocation = null;

        document.querySelectorAll(".status-option").forEach((card) => {
          card.classList.remove("selected");
        });

        document.getElementById("captured-photo").classList.add("hidden");
        document.getElementById("photo-controls").classList.add("hidden");
        document.getElementById("camera-placeholder").classList.remove("hidden");

        document.getElementById("location-result").classList.add("hidden");
        document.getElementById("location-loading").classList.remove("hidden");
        document.getElementById("location-loading").innerHTML = `
        <div class="w-14 h-14 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-slate-700 font-semibold">Mendapatkan lokasi otomatis...</p>
      `;

        if (map) {
          map.remove();
          map = null;
        }

        document.getElementById("submit-btn").disabled = true;

        // Get location again
        getLocation();
      }

      // Update Staff Select
      function updateStaffSelect() {
        const select = document.getElementById("staff-select");
        const currentValue = select.value;

        select.innerHTML = '<option value="">-- Pilih Nama Guru/Staff --</option>';

        staffList
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach((staff) => {
            const option = document.createElement("option");
            option.value = staff.name;
            option.textContent = staff.name;
            select.appendChild(option);
          });

        if (currentValue && staffList.some((s) => s.name === currentValue)) {
          select.value = currentValue;
        }

        select.onchange = checkFormValidity;
      }

      // Update Staff List (Admin)
      function updateStaffList() {
        const container = document.getElementById("staff-list");
        document.getElementById("staff-count").textContent = staffList.length;

        if (staffList.length === 0) {
          container.innerHTML = '<p class="text-slate-500 text-center py-6 font-medium">Belum ada data guru/staff</p>';
          return;
        }

        container.innerHTML = staffList
          .sort((a, b) => a.name.localeCompare(b.name))
          .map(
            (staff, index) => `
        <div class="flex items-center justify-between p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-2xl hover:shadow-md transition border-2 border-slate-200">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-gradient-to-br from-slate-600 to-slate-700 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg">
              ${staff.name.charAt(0).toUpperCase()}
            </div>
            <span class="font-bold text-slate-800">${staff.name}</span>
          </div>
          <div class="flex gap-2">
            <button onclick="showEditModal('${staff.id}', '${staff.name.replace(/'/g, "\\'")}')" class="text-slate-600 hover:text-white hover:bg-slate-600 p-2.5 rounded-xl transition shadow-sm" title="Edit">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            </button>
            <button onclick="showDeleteModal('staff', '${staff.id}', '${staff.name.replace(/'/g, "\\'")}')" class="text-red-500 hover:text-white hover:bg-red-500 p-2.5 rounded-xl transition shadow-sm" title="Hapus">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        </div>
      `,
          )
          .join("");

        // Update filter name dropdown
        updateFilterNameDropdown();
      }

      // Update Filter Name Dropdown
      function updateFilterNameDropdown() {
        const filterName = document.getElementById("filter-name");
        const currentValue = filterName.value;

        // Get unique names from staff list
        const uniqueNames = [...new Set(staffList.map((s) => s.name))].sort();

        filterName.innerHTML = '<option value="">üßë‚Äçüè´ Semua Guru/Staff</option>';
        uniqueNames.forEach((name) => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          filterName.appendChild(option);
        });

        // Restore previous selection if still valid
        if (currentValue && uniqueNames.includes(currentValue)) {
          filterName.value = currentValue;
        }
      }

      // Update Attendance Records (Admin)
      function updateAttendanceRecords() {
        console.log("Total attendance records:", attendanceList.length);
        console.log("Attendance data:", attendanceList);
        filterAttendance();
      }

      function clearFilter() {
        document.getElementById("filter-date").value = "";
        document.getElementById("filter-name").value = "";
        filterAttendance();
      }

      function filterAttendance() {
        const filterDate = document.getElementById("filter-date").value;
        const filterName = document.getElementById("filter-name").value;
        const container = document.getElementById("attendance-records");
        const filterInfo = document.getElementById("filter-info");

        console.log("Filter date:", filterDate);
        console.log("Filter name:", filterName);

        let filtered = [...attendanceList];
        let filterDescriptions = [];

        // Filter by name
        if (filterName) {
          filtered = filtered.filter((a) => a.name === filterName);
          filterDescriptions.push(filterName);
        }

        // Filter by date
        if (filterDate) {
          filtered = filtered.filter((a) => {
            // Extract date from ISO timestamp or use date field directly
            let recordDate = a.date;

            // If date is ISO timestamp, extract YYYY-MM-DD part
            if (recordDate && recordDate.includes("T")) {
              recordDate = recordDate.split("T")[0];
            }

            console.log("Comparing:", recordDate, "with", filterDate);
            return recordDate === filterDate;
          });
          filterDescriptions.push(formatDate(filterDate));
        }

        // Update filter info text
        if (filterDescriptions.length > 0) {
          filterInfo.textContent = `Menampilkan ${filtered.length} dari ${attendanceList.length} total absensi untuk ${filterDescriptions.join(" ‚Ä¢ ")}`;
        } else {
          filterInfo.textContent = `Menampilkan semua ${attendanceList.length} data absensi`;
        }

        console.log("Filtered records:", filtered.length, filtered);

        document.getElementById("attendance-count").textContent = filtered.length;

        if (filtered.length === 0) {
          if (filterDate) {
            container.innerHTML = '<p class="text-slate-500 text-center py-6 font-medium">Tidak ada data absensi untuk tanggal ini</p>';
          } else {
            container.innerHTML = '<p class="text-slate-500 text-center py-6 font-medium">Belum ada data absensi</p>';
          }
          return;
        }

        // Sort by timestamp (newest first)
        filtered.sort((a, b) => {
          const timeA = a.timestamp || a.createdAt || new Date(a.date + " " + a.time).toISOString();
          const timeB = b.timestamp || b.createdAt || new Date(b.date + " " + b.time).toISOString();
          return new Date(timeB) - new Date(timeA);
        });

        container.innerHTML = filtered
          .map((record) => {
            const statusColors = {
              masuk: "bg-gradient-to-r from-slate-600 to-slate-700 text-white",
              pulang: "bg-gradient-to-r from-amber-500 to-orange-600 text-white",
              dinas: "bg-gradient-to-r from-purple-500 to-purple-600 text-white",
            };

            const statusLabels = {
              masuk: "Masuk",
              pulang: "Pulang",
              dinas: "Dinas",
            };

            // Safely escape name for onclick
            const safeName = (record.name || "").replace(/'/g, "\\'").replace(/"/g, "&quot;");
            const safeId = (record.id || "").replace(/'/g, "\\'").replace(/"/g, "&quot;");

            // Format date and time properly from timestamp
            let formattedDate, displayTime;

            if (record.timestamp) {
              // Extract from ISO timestamp
              const timestamp = new Date(record.timestamp);
              formattedDate = timestamp.toLocaleDateString("id-ID", { weekday: "short", day: "numeric", month: "short", year: "numeric" });
              displayTime = timestamp.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
            } else {
              // Fallback to date and time fields
              formattedDate = formatDate(record.date);
              displayTime = record.time || "00:00:00";
            }

            return `
          <div class="bg-gradient-to-r from-slate-50 to-slate-100 rounded-2xl p-4 hover:shadow-md transition border-2 border-slate-200">
            <div class="flex items-start gap-4">
              <img src="${record.photo || ""}" alt="Foto" class="w-20 h-20 object-cover rounded-xl flex-shrink-0 shadow-md border-2 border-white" loading="lazy" onerror="this.style.background='#e5e7eb'; this.alt='Foto gagal dimuat';">
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-2">
                  <p class="font-bold text-slate-800 truncate text-base">${record.name || "Tidak diketahui"}</p>
                  <span class="px-3 py-1.5 rounded-xl text-xs font-black ${statusColors[record.status] || "bg-slate-500"} shadow-md">${statusLabels[record.status] || record.status}</span>
                </div>
                <div class="space-y-1 mb-2">
                  <p class="text-sm text-slate-600 font-semibold">üìÖ ${formattedDate}</p>
                  <p class="text-sm text-slate-600 font-semibold">üïê ${displayTime}</p>
                </div>
                <p class="text-xs text-slate-500 truncate" title="${record.address || "Lokasi tidak tersedia"}">${record.address || "Lokasi tidak tersedia"}</p>
              </div>
              <button onclick="showDeleteModal('attendance', '${safeId}', '${safeName}')" class="text-red-500 hover:text-white hover:bg-red-500 p-2 rounded-xl transition flex-shrink-0 shadow-sm" title="Hapus absensi">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
        `;
          })
          .join("");
      }

      // Add Staff
      async function addStaff(e) {
        e.preventDefault();

        if (isAddingStaff) return;

        const nameInput = document.getElementById("new-staff-name");
        const name = nameInput.value.trim();

        if (!name) {
          showToast("Nama tidak boleh kosong", "error");
          return;
        }

        // Check duplicate
        if (staffList.some((s) => s.name.toLowerCase() === name.toLowerCase())) {
          showToast("Nama guru/staff sudah ada", "error");
          return;
        }

        const url = getAppsScriptUrl();
        if (!url) {
          showToast("URL Apps Script belum dikonfigurasi", "error");
          return;
        }

        isAddingStaff = true;
        const addBtn = document.getElementById("add-staff-btn");
        addBtn.innerHTML = '<div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin"></div> Menambahkan...';
        addBtn.disabled = true;

        try {
          const response = await fetch(url, {
            method: "POST",
            body: JSON.stringify({
              action: "addStaff",
              name: name,
            }),
          });

          const result = await response.json();

          if (result.success) {
            showToast("Guru/Staff berhasil ditambahkan!", "success");
            nameInput.value = "";
            await loadAllData();
          } else {
            showToast(result.message || "Gagal menambahkan guru/staff", "error");
          }
        } catch (error) {
          showToast("Error menambahkan staff: " + error.message, "error");
        } finally {
          isAddingStaff = false;
          addBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
        </svg> Tambah Guru/Staff`;
          addBtn.disabled = false;
        }
      }

      // Edit Staff Functions
      let editTarget = null;

      function showEditModal(id, name) {
        editTarget = id;
        document.getElementById("edit-staff-name").value = name;
        document.getElementById("edit-modal").classList.remove("hidden");
      }

      function closeEditModal() {
        editTarget = null;
        document.getElementById("edit-staff-name").value = "";
        document.getElementById("edit-modal").classList.add("hidden");
      }

      async function saveEditStaff(e) {
        e.preventDefault();

        if (!editTarget) return;

        const newName = document.getElementById("edit-staff-name").value.trim();

        if (!newName) {
          showToast("Nama tidak boleh kosong", "error");
          return;
        }

        // Check duplicate (exclude current staff)
        const existingStaff = staffList.find((s) => s.id !== editTarget && s.name.toLowerCase() === newName.toLowerCase());
        if (existingStaff) {
          showToast("Nama guru/staff sudah ada", "error");
          return;
        }

        const url = getAppsScriptUrl();
        if (!url) {
          showToast("URL Apps Script belum dikonfigurasi", "error");
          return;
        }

        const saveBtn = document.getElementById("save-edit-btn");
        saveBtn.innerHTML = '<div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin"></div>';
        saveBtn.disabled = true;

        try {
          const response = await fetch(url, {
            method: "POST",
            body: JSON.stringify({
              action: "editStaff",
              id: editTarget,
              name: newName,
            }),
          });

          const result = await response.json();

          if (result.success) {
            showToast("Nama berhasil diubah!", "success");
            closeEditModal();
            await loadAllData();
          } else {
            showToast(result.message || "Gagal mengubah nama", "error");
          }
        } catch (error) {
          showToast("Error mengubah staff: " + error.message, "error");
        } finally {
          saveBtn.innerHTML = "Simpan";
          saveBtn.disabled = false;
        }
      }

      // Delete Functions
      function showDeleteModal(type, id, name) {
        deleteTarget = { type, id, name };
        document.getElementById("delete-modal-text").textContent = `Apakah Anda yakin ingin menghapus "${name}"?`;
        document.getElementById("delete-modal").classList.remove("hidden");
      }

      function closeDeleteModal() {
        deleteTarget = null;
        document.getElementById("delete-modal").classList.add("hidden");
      }

      async function confirmDelete() {
        if (!deleteTarget) return;

        const url = getAppsScriptUrl();
        if (!url) {
          showToast("URL Apps Script belum dikonfigurasi", "error");
          closeDeleteModal();
          return;
        }

        const btn = document.getElementById("confirm-delete-btn");
        btn.innerHTML = '<div class="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin"></div>';
        btn.disabled = true;

        try {
          const response = await fetch(url, {
            method: "POST",
            body: JSON.stringify({
              action: deleteTarget.type === "staff" ? "deleteStaff" : "deleteAttendance",
              id: deleteTarget.id,
            }),
          });

          const result = await response.json();

          if (result.success) {
            showToast("Data berhasil dihapus!", "success");
            await loadAllData();
          } else {
            showToast(result.message || "Gagal menghapus data", "error");
          }
        } catch (error) {
          showToast("Error menghapus data: " + error.message, "error");
        } finally {
          btn.innerHTML = "Hapus";
          btn.disabled = false;
          closeDeleteModal();
        }
      }

      // Password Protection
      const ADMIN_PASSWORD = "EBUVyML5h!g5Uek";

      function promptAdminPassword() {
        document.getElementById("password-modal").classList.remove("hidden");
        document.getElementById("admin-password-input").value = "";
        document.getElementById("password-error").classList.add("hidden");

        // Focus on password input
        setTimeout(() => {
          document.getElementById("admin-password-input").focus();
        }, 100);
      }

      function closePasswordModal() {
        document.getElementById("password-modal").classList.add("hidden");
        document.getElementById("admin-password-input").value = "";
        document.getElementById("password-error").classList.add("hidden");
      }

      function checkAdminPassword(e) {
        e.preventDefault();

        const inputPassword = document.getElementById("admin-password-input").value;
        const errorMsg = document.getElementById("password-error");

        if (inputPassword === ADMIN_PASSWORD) {
          closePasswordModal();
          showPage("admin");
          showToast("Berhasil masuk ke Admin Panel", "success");
        } else {
          errorMsg.classList.remove("hidden");
          document.getElementById("admin-password-input").value = "";
          document.getElementById("admin-password-input").focus();

          // Shake animation
          const modal = document.querySelector("#password-modal > div");
          modal.style.animation = "none";
          setTimeout(() => {
            modal.style.animation = "shake 0.5s";
          }, 10);
        }
      }

      // Helper Functions
      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString("id-ID", { weekday: "short", day: "numeric", month: "short", year: "numeric" });
      }

      // Initialize
      initApp();
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'9c72cda0b1e8fd91',t:'MTc2OTk2MzExMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener) document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState && ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
